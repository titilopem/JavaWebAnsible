---
- name: Deploy WAR file to Tomcat
  hosts: group1
  become: yes

  vars:
    tomcat_service: "{{ 'tomcat8' if ansible_distribution == 'Ubuntu' else 'tomcat' }}"

  tasks:
    - name: Ensure the target directory exists
      ansible.builtin.file:
        path: "~/apache*/webapps/"
        state: directory

    - name: Copy the new WAR file to the target directory
      ansible.builtin.copy:
        src: "{{ workspace }}/target/*.war"
        dest: "~/apache*/webapps/"

    - name: Remove old WAR files from Tomcat webapps directory
      ansible.builtin.find:
        paths: "~/apache*/webapps/"
        patterns: "*.war"
        recurse: yes
      register: old_war_files

    - name: Remove old WAR files
      ansible.builtin.file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ old_war_files.files }}"

    - name: Reload Tomcat
      ansible.builtin.service:
        name: "{{ tomcat_service }}"
        state: reloaded

    - name: Start Tomcat
      ansible.builtin.service:
        name: "{{ tomcat_service }}"
        state: started
...
